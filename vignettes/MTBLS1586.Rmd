---
title: "Description and usage of MetClassNetR: MTBLS1586"
output:
    BiocStyle::html_document:
        toc_float: true
vignette: >
    %\VignetteIndexEntry{Description and usage of Description and usage of genedataRutils}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
    %\VignettePackage{Spectra}
    %\VignetteDepends{Spectra,BiocStyle}
---

```{r style, echo = FALSE, results = 'asis', message=FALSE}
BiocStyle::markdown()
```

```{r, echo = FALSE, message = FALSE}
library(BiocStyle)
```

# Introduction

XXX (Description of MTBLS1586)

# Setup

## Load required libries

<code>MetClassNetR</code> integrates functions from different libraries.

```{r libraries, message=FALSE, warning=FALSE}
# installation of additional packages
# devtools::install_github("MetClassNet/MetNet", ref = "devel_Liesa") 
# devtools::install_github("MetClassNet/MetClassNetR", ref = "devel_liesa") 

# load required libraries
library(tidyverse)
library(MetNet)
library(MetClassNetR)
library(QFeatures)
library(Spectra)
library(MsCoreUtils)
library(MsBackendMgf)
```

## Reading of MS1 data

MS1 data is read from Metabolights MAF or mzTab-M files into a <code>QFeatures</code>
object.

```{r ms1, message=FALSE}
# Metabolights MAF files
pos_maf <- system.file("extdata/MTBLS1586/m_MTBLS1586_LC-MS_positive_reverse-phase_metabolite_profiling_v2_maf.tsv", package = "MetClassNetR")
neg_maf <- system.file("extdata/MTBLS1586/m_MTBLS1586_LC-MS_positive_reverse-phase_metabolite_profiling_v2_maf.tsv", package = "MetClassNetR")

# create QFeature object
mtbls1586_qf_pos <- readMaf(file(pos_maf),
                                  ecol = 23:64,
                                  fnames = 22,
                                  name = "mtbls1586_pos",
                                  sep = "\t")

mtbls1586_qf_neg <- readMaf(file(neg_maf),
                                  ecol = 23:64,
                                  fnames = 22,
                                  name = "mtbls1586_neg",
                                  sep = "\t")
```


Addition assay and sample data???

```{r ms1_metadata, message = FALSE, warning=FALSE}
# pos_assay <- system.file("extdata/MTBLS1586/a_MTBLS1586_LC-MS_positive_reverse-phase_metabolite_profiling.txt", package = "MetClassNetR")
# pos_sample <-
# 
# pos_assay_data <- read_tsv(pos_assay, col_names = TRUE)
# 
# mtbls1586_qf_pos$sampleName <- pos_assay_data$`Sample Name`
# 
# colData(mtbls1586_qf_pos)
```



## Reading of MS2 data

MS2 data is read from a .mgf or .msp file into a <code>Spectra</code> object.

```{r ms2, message=FALSE, warning=FALSE}
# get MS2 data in .mgf files
pos_mgf <- system.file("extdata/MTBLS1586/ms2_MTBLS1586_LC-MS_positive_reverse-phase_metabolite_profiling.mgf", package = "MetClassNetR")
neg_mgf <- system.file("extdata/MTBLS1586/ms2_MTBLS1586_LC-MS_negative_reverse-phase_metabolite_profiling.mgf", package = "MetClassNetR")

# load MS2 data 
ms2_spectra_pos <- Spectra::Spectra(pos_mgf,
                           source = MsBackendMgf(),
                           backend = MsBackendDataFrame())

ms2_spectra_neg <- Spectra::Spectra(neg_mgf,
                           source = MsBackendMgf(),
                           backend = MsBackendDataFrame())
```


Adjust variables in spectraVariables()

```{r}
ms2_spectra_pos$uniqueID <- ms2_spectra_pos$CLUSTER_ID
ms2_spectra_pos$CLUSTER_ID <- NULL
```


## Reading of transformation file

ZZZ

```{r transformation}
transformations_file <- system.file("extdata/MTBLS1586/transformations_MTBLS1586.csv", package = "MetClassNetR")
transformations <- read_csv(transformations_file, col_names = TRUE) %>% as.data.frame()
```



## Quality check of input

ZZZ

## Setup for networks

AAA

```{r}
master <- list()
```

# Analysis

## Mass difference Network
```{r mass_difference}
# Create mass difference network
massdiff <- qfeat_structural(x = mtbls1586_qf_pos,
                             assay_name = "mtbls1586_pos",
                             transformation = transformations,
                             ppm = 10)

# Create list of adjacency matrix
massdiff_l <- adjacency_list(x=massdiff, 
                             from = "structural")

# Summary of the list
sum_mz <- summary_mz(adjacency_list = massdiff_l)

# for big data: filter for counts higher 1000
sum_mz_f <- summary_mz(adjacency_list = massdiff_l,
                     filter = 1000)

# append mass difference network
master <- c(master, massdiff)

```


## Add manual annotatation 

```{r manual_annotation}
# Add manual annotations to mass-difference adjacency list
#name_l <- annotaionNames(list = massdiff_l, names = #### QFeature)

# Filter for manual annotations
#annotationFiltered <- filter(annotationList, is.na(annotationList$Var1_annotation) == F, is.na(annotationList$Var2_annotation) == F, annotationList$Var1_annotation != "", annotationList$Var2_annotation != "")

```


## Correlation network

ABC

```{r correlation}
# Correlation network using pearson and spearman correlation
pears_corr <- qfeat_statistical(x = mtbls1586_qf_pos,
                             assay_name = "mtbls1586_pos", 
                                model = c("pearson"))

# Create list from correlation acjacency matrix 
pears_l <- adjacency_list(x = pears_corr, 
                          from = "statistical")

master <- c(master, pears_corr)

# Correlation network using pearson and spearman correlation
# Positive, negative and p values are displayed
pears_corr_p <- qfeat_statistical(x = mtbls1586_qf_pos,
                             assay_name = "mtbls1586_pos",
                                model = c("pearson"),
                                p = TRUE)

master <- c(master, pears_corr_p)
# 
# pears_p_l <- adjacency_list(x = pears_corr_p,
#                             from = "statistical")
```

## Threshold for correlation

ABC

```{r threshold}
# Threshold arguments for correlation values 
# Values above set to '1'
#args_thr <- list("pearson" = 0.95, "spearman" = 0.95, threshold = 1)
# Thresholding by correlation value
#corr_thr <- threshold(statistical = pears_corr, 
#                     type = "threshold", 
#                     args = args_thr)

#### Does not work yet!!

# Threshold arguments for p values 
# Values below set to '1'
#args_thr_p <- list("pearson" = 0.05, "spearman" = 0.05, threshold = 1)
# Thresholding by p value
#stat_adj_thr_p <- threshold(statistical = stat_adj_l_p, type = "threshold_p", 
#                           args = args_thr_p)
```



## Combine mass-difference and correlation network

ABC ()

```{r combine}
# Combine mass difference network and correlation network by thresholded pearson correlation
#cons_adj <- combine(structural = struct_adj, statistical = stat_adj_thr_p, model = "pearson", weighted_statistical = stat_adj_l_p)

# Combine mass difference network and correlation network by thresholded combination of pearson and spearman correlation
#cons <- combine(structural = struct_adj, statistical = stat_adj_thr, model = "combined")


## does not work yet
# Create a list from combined adjacency matrix
#comb_p_list <- adjacency_list(x = cons_adj_std, from = "combine")
# Summary of the list
#sum_comb_p_list <- sum_mass(comb_p_list)
# Plot the summary
#plot_comblist <- ggplot(sum_comb_p_list, aes(x=Type, y=Counts)) + geom_bar(stat = "identity") + theme_minimal() + coord_flip() +labs(title = "Numbers of determined mass differences - HLH30 lipid data ", subtitle = "(positive ionization) 
#Filtered: p-value < 0.05")
#plot(plot_comblist) 
# For big data: display only values above 500
#sumlistcomb_filtered <- filter(sum_comb_p_list, sum_comb_p_list$Counts >= 500)
#plot_comblist_f <- ggplot(sumlistcomb_filtered, aes(x=Type, y=Counts)) + geom_bar(stat = "identity") + theme_minimal() + 
#  coord_flip() + scale_y_continuous(breaks = seq(0, 6000, 500)) + 
#  labs(title = "Numbers of determined mass differences - HLH30 lipid data", subtitle = "(positive ionization)
#  Filtered: p-value < 0.05 & Counts > 500")
#plot(plot_comblist_f)
```


## Homologue Series

ABC


```{r homolseries}
# library(nontarget)
# library(igraph)
# 
# homol <- qfeat_homol(x = mtbls1586_qf_pos,
#                              assay_name = "mtbls1586_pos",
#                       elements=c("C","H","O"), use_C=TRUE,
#                       minmz=5, 	maxmz=50,
#                       minrt=5,  maxrt=60,
#                       ppm=TRUE,
#                       mztol=5,  rttol=5,
#                       minlength=4,
#                       mzfilter=FALSE,
#                       spar=.45, 	R2=.98,
#                       plotit=FALSE)
```


## MS2 similarity network

ABS

```{r ms2_network}

# costum matching function
#specNrow <-  function(x, y, ...) nrow(x)

# this is work around until Spectra is getting fixed
mydotproduct <- function(x, y, type = NA, ...) MsCoreUtils::ndotproduct(x, y, ...)

# test with multiple functions
ms2_similarity <- spec_molNetwork(ms2_spectra_pos,
                                  methods = c("mydotproduct"),
                                  tolerance = 0.005,
                                  type = "inner")
```


## Export networks to gml format 

XXX

```{r export2gml}
## does not work yet
# Mass difference network to gml
#gml <- exportNet2gml(struct_adj, from = "structural", adjacency_list = struct_list)
## Correlation network to gml (including p values)
#gml <- exportNet2gml(stat_adj_l_p, from = "statistical+p", adjacency_list = adj_stat_p)
## Combined network to gml
#gml <- exportNet2gml(cons_adj, from = "combine", adjacency_list = comb_p_list)
```


```{r graph_export}
# library(tibble)
# library(dplyr)
# library(igraph)
# library(visNetwork) # for visNetwork() and friends
# library(networkD3)  # for saveNetwork()
# 
# 
# el <- as_tibble(homol[["Peaks in homologue series"]]) %>% 
#     filter(`to ID` != "0") %>% select (c("peak ID", "to ID", 
#                                          "m/z increment", "RT increment"))
# 
# g <- el %>% select (c("peak ID", "to ID")) %>% as.matrix %>% graph_from_edgelist
# 
# ## Write to File
# write_graph(g, "/tmp/g.gml", "gml")
# 
# ## Some Plotting
# data <- toVisNetworkData(g)
# vn <- visNetwork(nodes = data$nodes, 
#                  edges = data$edges)
# vn
# saveNetwork(vn, "/tmp/vn.html")
```




