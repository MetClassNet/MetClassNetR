---
title: "Description and usage of MetClassNetR: MTBLS1586"
output:
    BiocStyle::html_document:
        toc_float: true
vignette: >
    %\VignetteIndexEntry{Description and usage of Description and usage of genedataRutils}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
    %\VignettePackage{Spectra}
    %\VignetteDepends{Spectra,BiocStyle}
---

```{r style, echo = FALSE, results = 'asis', message=FALSE}
BiocStyle::markdown()
```

```{r, echo = FALSE, message = FALSE}
library(BiocStyle)
```

# Introduction

XXX (Description of MTBLS1586)

## Load required libries

```{r setup}
# installation of additional packages
# install_github("MetClassNet/MetNet", ref = "devel_Liesa") 
# install_github("MetClassNet/MetClassNetR", ref = "devel_liesa") 

# load required libraries
library(tidyverse)
library(devtools)
library(MetNet)
library(MetClassNetR)
library(QFeatures)
library(Spectra)
library(MsCoreUtils)
library(MsBackendMgf)
```

## Reading of MS1 data

XXX

```{r ms1_data}
# Metabolights MAF files
pos_maf <- system.file("extdata/MTBLS1586/m_MTBLS1586_LC-MS_positive_reverse-phase_metabolite_profiling_v2_maf.tsv", package = "MetClassNetR")
neg_maf <- system.file("extdata/MTBLS1586/m_MTBLS1586_LC-MS_positive_reverse-phase_metabolite_profiling_v2_maf.tsv", package = "MetClassNetR")

# read data
pos_data <- read_tsv(pos_maf, col_names = TRUE)
neg_data <- read_tsv(neg_maf, col_names = TRUE)

# create QFeature object
mtbls1586_qf_pos <- readQFeatures(pos_data, ecol = 23:ncol(pos_data), fnames = 22, name = "mtbls1586_pos")
mtbls1586_qf_neg <- readQFeatures(neg_data, ecol = 23:ncol(neg_data), name = "mtbls1586_neg")
```

## Reading of MS2 data

YYY

```{r ms2_data, echo=FALSE}
# get MS2 data in .mgf files
pos_mgf <- system.file("extdata/MTBLS1586/ms2_MTBLS1586_LC-MS_positive_reverse-phase_metabolite_profiling.mgf", package = "MetClassNetR")
neg_mgf <- system.file("extdata/MTBLS1586/ms2_MTBLS1586_LC-MS_negative_reverse-phase_metabolite_profiling.mgf", package = "MetClassNetR")

# load MS2 data 
ms2_spectra_pos <- Spectra::Spectra(pos_mgf,
                           source = MsBackendMgf(),
                           backend = MsBackendDataFrame())

ms2_spectra_neg <- Spectra::Spectra(neg_mgf,
                           source = MsBackendMgf(),
                           backend = MsBackendDataFrame())
```

## Reading of transformation file

ZZZ

```{r}
transformations_file <- 'Lipid_table.csv' # mass-difference file
transformations <- read.csv(transformations_file) %>% select(group, formula, mass) %>% as.data.frame()
```



## Quality check of input

ZZZ

## Mass difference Network
```{r mass_difference}
# Create mass difference network
massdiff <- qfeat_structural(x = data_qF, 
                 assay_name = "pos", 
                 transformation = transformations, 
                 ppm = 10)

# Create list of adjacency matrix
massdiff_l <- adjacency_list(x=massdiff, 
                             from = "structural")

# Summary of the list
sum_mz <- summary_mz(adjacency_list = massdiff_l)

# for big data: filter for counts higher 1000
sum_mz_f <- summary_mz(adjacency_list = massdiff_l,
                     filter = 1000)

```


### Add manual annotatation 

```{r manual_annotation}
# Add manual annotations to mass-difference adjacency list
#name_l <- annotaionNames(list = massdiff_l, names = #### QFeature)

# Filter for manual annotations
#annotationFiltered <- filter(annotationList, is.na(annotationList$Var1_annotation) == F, is.na(annotationList$Var2_annotation) == F, annotationList$Var1_annotation != "", annotationList$Var2_annotation != "")

```




## Correlation network
```{r correlation}
# Correlation network using pearson and spearman correlation
pears_corr <- qfeat_statistical(x = data_qF, 
                                assay_name = "pos", 
                                model = c("pearson"))

# Create list from correlation acjacency matrix 
pears_l <- adjacency_list(x = pears_corr, 
                          from = "statistical")



# Correlation network using pearson and spearman correlation
# Positive, negative and p values are displayed
pears_corr_p <- qfeat_statistical(x = data_qF, 
                                assay_name = "pos", 
                                model = c("pearson"),
                                p = TRUE)

pears_p_l <- adjacency_list(x = pears_corr_p, 
                          from = "statistical")
```
### Threshold for correlation
```{r threshold}
# Threshold arguments for correlation values 
# Values above set to '1'
#args_thr <- list("pearson" = 0.95, "spearman" = 0.95, threshold = 1)
# Thresholding by correlation value
#corr_thr <- threshold(statistical = pears_corr, 
#                     type = "threshold", 
#                     args = args_thr)

#### Does not work yet!!

# Threshold arguments for p values 
# Values below set to '1'
#args_thr_p <- list("pearson" = 0.05, "spearman" = 0.05, threshold = 1)
# Thresholding by p value
#stat_adj_thr_p <- threshold(statistical = stat_adj_l_p, type = "threshold_p", 
#                           args = args_thr_p)
```



## Combine mass-difference and correlation network
```{r combine}
# Combine mass difference network and correlation network by thresholded pearson correlation
#cons_adj <- combine(structural = struct_adj, statistical = stat_adj_thr_p, model = "pearson", weighted_statistical = stat_adj_l_p)

# Combine mass difference network and correlation network by thresholded combination of pearson and spearman correlation
#cons <- combine(structural = struct_adj, statistical = stat_adj_thr, model = "combined")


## does not work yet
# Create a list from combined adjacency matrix
#comb_p_list <- adjacency_list(x = cons_adj_std, from = "combine")
# Summary of the list
#sum_comb_p_list <- sum_mass(comb_p_list)
# Plot the summary
#plot_comblist <- ggplot(sum_comb_p_list, aes(x=Type, y=Counts)) + geom_bar(stat = "identity") + theme_minimal() + coord_flip() +labs(title = "Numbers of determined mass differences - HLH30 lipid data ", subtitle = "(positive ionization) 
#Filtered: p-value < 0.05")
#plot(plot_comblist) 
# For big data: display only values above 500
#sumlistcomb_filtered <- filter(sum_comb_p_list, sum_comb_p_list$Counts >= 500)
#plot_comblist_f <- ggplot(sumlistcomb_filtered, aes(x=Type, y=Counts)) + geom_bar(stat = "identity") + theme_minimal() + 
#  coord_flip() + scale_y_continuous(breaks = seq(0, 6000, 500)) + 
#  labs(title = "Numbers of determined mass differences - HLH30 lipid data", subtitle = "(positive ionization)
#  Filtered: p-value < 0.05 & Counts > 500")
#plot(plot_comblist_f)
```


## Export networks to gml format 
```{r export2gml}
## does not work yet
# Mass difference network to gml
#gml <- exportNet2gml(struct_adj, from = "structural", adjacency_list = struct_list)
## Correlation network to gml (including p values)
#gml <- exportNet2gml(stat_adj_l_p, from = "statistical+p", adjacency_list = adj_stat_p)
## Combined network to gml
#gml <- exportNet2gml(cons_adj, from = "combine", adjacency_list = comb_p_list)
```

#Homologue Series
```{r homolseries}
library(nontarget)
library(igraph)

homol <- qfeat_homol(x = data_qF, assay_name = "pos",
                      elements=c("C","H","O"), use_C=TRUE,
                      minmz=5, 	maxmz=50,
                      minrt=5,  maxrt=60,
                      ppm=TRUE,
                      mztol=5,  rttol=5,
                      minlength=4,
                      mzfilter=FALSE,
                      spar=.45, 	R2=.98,
                      plotit=FALSE)
```

```{r graph_export}
library(tibble)
library(dplyr)
library(igraph)
library(visNetwork) # for visNetwork() and friends
library(networkD3)  # for saveNetwork()


el <- as_tibble(homol[["Peaks in homologue series"]]) %>% 
    filter(`to ID` != "0") %>% select (c("peak ID", "to ID", 
                                         "m/z increment", "RT increment"))

g <- el %>% select (c("peak ID", "to ID")) %>% as.matrix %>% graph_from_edgelist

## Write to File
write_graph(g, "/tmp/g.gml", "gml")

## Some Plotting
data <- toVisNetworkData(g)
vn <- visNetwork(nodes = data$nodes, 
                 edges = data$edges)
vn
saveNetwork(vn, "/tmp/vn.html")
```


```{r ms2_network}

```

